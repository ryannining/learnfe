<!DOCTYPE html>
<html>
    <head>
        <title>Simulasi Gravitasi</title>
        <style>  
          /* Define a blinking animation */
  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0; }
    100% { opacity: 1; }
  }

  /* Apply the animation to the text */
  .blinking-text {
    animation: blink 1s infinite;
  }
            canvas {
                border: 1px solid black;
                cursor: grab;
            }
        </style>
    </head>
    <body>
      <h3 id=pause0 class="blinking-text">Pause ! Tekan tombol Mulai </h3>
        <table width=100%>
            <tr valign=top>
                <td width=1200>
                    <canvas id="canvas" width="1200" height="900"></canvas>
                    <canvas id="canvas2" width="100" height="100" style="position:absolute;left:1110px;top:10px"></canvas>
                    <canvas id="canvas3" width="200" height="200" style="position:absolute;left:1010px;top:120px"></canvas>
                </td>
                <td><h2 id=pause1 style="display:none" class="blinking-text">Pause ! Tekan tombol P untuk melanjutkan</h2>
                    <br>
                    <font color=red>-- merah : Vektor gaya total</font>
                    <font color=orange>-- kuning : Vektor gaya roket</font>
                    <font color=green>-- hijau : Vektor kecepatan</font>
                    <br>
                    Data simulasi<br>
                    <span id=data></span>
                    <table width="100%"><tr valign=top><td>
                      
                    <b>Konstanta G</b><input type=text id=cG size=12 value=6.67430e-11><button id="applyG">Apply</button><br>
                    <b>Setting Roket Peluncur</b><br>
                    Masa Rk1 <input type=text id=rm1 size=5 value=21e4>kg<br>
                    Masa Rk2 <input type=text id=rm2 size=5 value=21e4>kg<br>
                    Masa L.M <input type=text id=sm size=5 value=15000>kg<br>
                    Daya Rk1  <input type=text id=f0 size=5 value=34000>kN<br>
                    Daya Rk1 <input type=text id=f1 size=5 value=2000>kN<br>
                    Alt Rk1 <input type=text id=h0 size=5 value=100>km<br>
                    Vel Rk2 <input type=text id=v0 size=5 value=30000>km/h<br>
                    Sep. brake <input type=text id=brake size=5 value=0.9>km/h<br>
                    <input type=checkbox  checked id=trail1>Tampilkan trail<br>
                    </td><td>
                      R-Bumi <input type=text id=r1 size=5 value=6500>km<br>
                     Masa Bumi <input type=text id=mass size=5 value=6e24>kg<br>
                     V0  <input type=text id=v01 size=8 value=107e3>km/h<br><br>
                     R-Bulan <input type=text id=r2 size=8 value=1737e3>km<br>
                     Masa  <input type=text id=mas2 size=8 value=7.35e22>kg<br>
                     Jarak  <input type=text id=d2 size=8 value=363104>km<br>
                     V0  <input type=text id=v02 size=8 value=3683>km/h<br>
                     <br>                      
                     R-Matahari <input type=text id=rsun size=8 value=699e3>km<br>
                     Masa  <input type=text id=massun size=8 value=1.98e30>kg<br>
                     Jarak  <input type=text id=dsun size=8 value=15e7>km<br>
                    </td>></tr></table><hr>
                    View Scale <input type="range" min="1" max="10000" value="10000" class="slider" id="scale">
                    &nbsp;
                    Sim timeStep <input type="range" min="1" max="1000" value="1" class="slider" id="anim">
                    <br><br>
                    <button id="startBtn">Mulai</button>
                    <button id="start2Btn">Mulai &gt;&gt;</button>
                    <button id="pauseBtn">Pause</button>
                    <button id="view1">Lihat L.M</button>
                    <button id="view2">Lihat Bulan</button>
                    <button id="view3">Lihat Bumi</button>
                    <button id="view4">Lihat Semua</button>
                    <br>
                    <button id="rem1">Rem Bulan</button>
                    <button id="rem2">Buang Bulan</button>
                    
                    
                    <br><hr>LUNAR Module system
                    <table width="100%"><tr valign=top><td>
                    Daya roket  <input type=text id=f3 size=5 value=45>kN<br>
                    Manual roket<input type=text id=burntime size=3 value=5>menit<br>
                    Manual Tombol keyboard: <br>(1) Aktifkan roket searah <br>(2) Aktifkan roket lawan arah (rem) <br>(3) Aktifkan roket arah ke bulan
                    <br>(4/P)Pause
                    </td><td><input type=checkbox  id=cek1>Skrip otomatis (time,key, duration)<br>
                    <textarea id="actionList" rows="5" cols="30" placeholder="Enter actions here (time,key, duration)">
12800,1,15
41500,1,25
50000,3,4
75000,2,25
115000,2,5
280010,3,1
281000,1,2
289500,2,14
292000,1,5
280000,4,0
</textarea></td></tr></table>
<hr>
<input type=checkbox checked=true id=tidalforce>Visualisasikan Gaya Pasang surut (diskala supaya terlihat)
<br><input type=checkbox checked id=tidalmoon>Gaya dari bulan (merah)
<br><input type=checkbox xchecked id=tidalsun>Gaya dari matahari (kuning)
<br><input type=checkbox  id=tidalres>Gaya Resultan (abu2)
<hr>
<br><input type=checkbox checked id=fase1>Fase bulan dilihat dari bumi/<input type=checkbox xchecked id=fase3>dari L.M
<br><input type=checkbox checked id=fase2>Fase bumi dilihat dari bulan/<input type=checkbox checked id=fase4>dari L.M
<br>Info Ukuran sudut benda memakai rumus:
<i>2 * atan(objekRadius / Jarak)</i>



                </td>
            </tr>
        </table>
        <script>

            function calculateColorWithExposure(r, g, b, exposure) {

              // Calculate new R, G, B values based on exposure
              r = Math.min(Math.max(r*0.1 + r * exposure, 0), 255);  
              g = Math.min(Math.max(g*0.1 + g * exposure, 0), 255);
              b = Math.min(Math.max(b*0.1 + b * exposure, 0), 255);

              // Return new color as RGB array
              return [r, g, b];

            }
                
            function renderPhase(can,x, y, radius, colb, col,lightVector,info) {

              const canvas = document.getElementById(can);
              const ctx = canvas.getContext('2d');

              const width = canvas.width;
              const height = canvas.height;

              const dx = lightVector[0];
              const dy = lightVector[1]; 
              const dz = lightVector[2];
              ctx.beginPath();
              c1 = `rgb(${colb[0]},${colb[1]},${colb[2]},0.5)`;
              ctx.fillStyle='#000020';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.fill();

              //ctx.fillStyle = 'blue';
              //ctx.arc(x, y, radius,0,Math.PI*2);
              //ctx.fill();
              scd=Math.floor(radius/20);
              sc=Math.max(1,scd*2);
              wd=Math.ceil(radius/sc);   
              for(let i = -wd; i < wd; i++) {
                for(let j = -wd; j < wd; j++) {

                  // Hitung koordinat pixel
                  let px = i*sc;
                  let py = j*sc;
                  let pz = Math.sqrt(radius**2 - px**2 - py**2);

                  // Hitung vektor normal pixel
                  let nx = px / radius;
                  let ny = py / radius;
                  let nz = pz / radius;

                  // Hitung intensitas cahaya
                  let brightness = nx * dx + ny * dy + nz * dz;
                  brightness = Math.max(brightness, 0);  

                  if(px**2 + py**2 < radius**2) {
                    outputRGB=calculateColorWithExposure(  col[0], col[1], col[2], brightness);
                    ctx.fillStyle = `rgb(${outputRGB[0]},${outputRGB[1]},${outputRGB[2]})`;
                    ctx.fillRect(x+px-scd,y+py-scd,sc,sc);
                  }

                }
              }
              ctx.beginPath();
              ctx.strokeStyle = '#000020';
              ctx.lineWidth=sc+2;
              ctx.arc(x, y, radius,0,Math.PI*2);
              ctx.stroke();
              ctx.save();
              ctx.beginPath();
              ctx.globalCompositeOperation = 'lighter';
              ctx.fillStyle=c1;
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.fill();
              ctx.restore();
              
              ctx.beginPath();
              ctx.fillStyle = 'white';
              ctx.font = "12px Arial";
              ctx.fillText(info, 2, 12);
              ctx.fill();

            }          
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            let isPanning = false;
            let followsatelite = 1;
            let lastMouseX = 0;
            let lastMouseY = 0;
            let sactions=[];

            canvas.addEventListener('mousedown', (e)=>{
                isPanning = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                canvas.style.cursor = 'grabbing';
            }
            );

            canvas.addEventListener('mousemove', (e)=>{
                if (isPanning) {
                    const deltaX = e.clientX - lastMouseX;
                    const deltaY = e.clientY - lastMouseY;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                    canvas.style.cursor = 'grabbing';
                    if (followsatelite!=4)followsatelite = 0;
                    xw += deltaX;
                    yw += deltaY;
                }
            }
            );

            canvas.addEventListener('mouseup', ()=>{
                isPanning = false;
                canvas.style.cursor = 'grab';
            }
            );

            canvas.addEventListener('wheel', (e)=>{
                sl = $('scale');
                if (e.deltaY < 0) {
                    sl.value = sl.value * 1 + 2;
                } else {
                    sl.value = sl.value * 1 - 2;
                }
            }
            );

            trail = [];
            nn = 0;
            function pushtrail(d) {
                nn++;
                if (nn < (50+ (trail.length/2)))
                    return;
                nn = 0;
                if (trail.length > 1000)
                    trail.shift();
                trail.push(d);
            }
            function $(id) {
                return document.getElementById(id);
            }
            function getval(id) {
                return parseFloat($(id).value);
            }
            
            satburn=0;
            var G = 6.67430e-11;
            // Konstanta gravitasi universal (m^3 kg^-1 s^-2)

            // Skala: 1 pixel = 100 km
            scale = 50000;
            // 1 pixel = 100 km
            rscale = 1.0 / scale;
            // 1 pixel = 100 km

            rocketF1 = 7400000;
            // in newton
            rocketF2 = 7400000;
            rocketF3 = 0; 
            // in newton
            // Objek pertama (Bumi)
            m1 = 6e24;
            // Massa Bumi (kg)
            r1 = 6000 * 1000;
            // Radius Bumi (m)
            xw = canvas.width / 2;
            // Posisi horizontal objek pertama (m)
            yw = canvas.height / 2;
            // Posisi vertikal objek pertama (m)
            x1 = 0;
            y1 = 0;
            // Objek kedua (Objek bergerak)
            rm1 = 42e4;
            // Massa objek bergerak (kg) // massa roket + satelit
            rm2 = 42e2;
            satm=42e1;
            // Massa objek bergerak (kg) // massa satelit
            const r2 = 0.5 * 1000;
            // Radius objek bergerak (m)
            v2 = 30000 * 1000 / 3600;
            // Kecepatan awal objek bergerak (m/s)
            h2 = 400 * 1000;
            // Ketinggian objek bergerak dari permukaan objek pertama (m)
            h0 = 0;
            x2 = x1 + h2 + r1 + r2;
            // Posisi horizontal awal objek kedua (m)
            y2 = y1;
            // Posisi vertikal awal objek kedua (m/s)
            vx1=0;
            vy1=0;
            // rotasi bumi dan bulan
            vro1=2*Math.PI/(24*3600);
            ro1=0;
            vro2=-2*Math.PI/(28*24*3600);
            ro2=0;
            sunx=-150000000000;
            suny=0;
            sunm1=1.98e30;
            sunr1=1398000000/2;
            
            
            let vx2 = 0;
            // Kecepatan horizontal awal objek kedua (m/s)
            let vy2 = v2;
            // Kecepatan vertikal awal objek kedua (m/s)
            x3 = 0;
            y3 = 0;
            vx3 = 0;
            vy3 = 0;
            moonvx = 0;
            moonvy = 3683 * 1000 / 3600;
            moonx = -363104;
            moony = 0;
            moonr = 3474 * 500;
            moonmass = 7.35e22;
            burntime=0;

            // Tombol
            const startBtn = document.getElementById('startBtn');
            const start2Btn = document.getElementById('start2Btn');
            const pauseBtn = document.getElementById('pauseBtn');
            const view1 = document.getElementById('view1');
            const view2 = document.getElementById('view2');
            const view3 = document.getElementById('view3');
            const rem1 = document.getElementById('rem1');
            const rem2 = document.getElementById('rem2');
            const applyG = document.getElementById('applyG');
            // Status simulasi
            let isRunning = false;
            let requestId;

            // Fungsi menggambar objek
            stage = 0;
            tgV = 0;
            lastfollow=0;
            function autoscale() {
                // auto xw and yw and scale
                scale = (10080 - getval("scale")) * 50;
                
                if (followsatelite == 1) {
                    xw = canvas.width / 2 - x2 * rscale;
                    // Posisi horizontal objek pertama (m)
                    yw = canvas.height / 2 - y2 * rscale;
                    // Posisi vertikal objek pertama (m)
                } else if (followsatelite == 2) {
                    // follow moon
                    xw = canvas.width / 2 - moonx * rscale;
                    // Posisi horizontal objek pertama (m)
                    yw = canvas.height / 2 - moony * rscale;
                    // Posisi vertikal objek pertama (m)
                } else if (followsatelite == 4) {
                    // follow moon
                    // Posisi vertikal objek pertama (m)
                    // special scale for sun
                    scale=(-0.01*sunx/canvas.height)+100*scale;
                }
                rscale = 1.0 / scale;
                if (lastfollow!=4 && followsatelite==4)
                {
                  xw = canvas.width / 2 - 0*0.5 * rscale;
                  // Posisi horizontal objek pertama (m)
                  yw = canvas.height / 2 - 0 * rscale;
                }
                lastfollow=followsatelite;
            }
            runscript=0;
            numcalc=0;
            function reset() {
                G=getval("cG");
                satburn=0;
                numcalc=0;
                simtime=0;
                trail=[];
                loadActions();
                runscript=$("cek1").checked;
                r1 = getval("r1") * 1000;
                // Radius Bumi (m)
                rocketF1 = getval("f0") * 1000;
                // in newton
                rocketF2 = getval("f1") * 1000;
                // in newton
                rocketF3 = getval("f3") * 1000;
                m1 = getval("mass");
                rm1 = getval("rm1");
                rm2 = getval("rm2");
                satm = getval("sm");
                
                h2 = getval("h0") * 1000;
                h0 = 0;
                ro2 = Math.PI;
                ro1 = y2 = y1 = x1 = 0;
                x2 = r1 + h0;
                stage = 0;
                // from land
                tgV = getval("v0");
                v2 = tgV * 1000 / 3600;
                
                sunx=-getval("dsun")*1000;
                suny=0;
                sunm1=getval("massun");
                sunr1=getval("rsun")*1000;

                
                moonvx = -getval("v02") * 1000 / 3600;
                moony = getval("d2")*1000;
                moonx = 0;
                moonr = getval("r2");
                moonmass = getval("mas2");
                vx2 =vx1= 0;
                vy1=vy2=moonvy=0;//getval("v01")*1000/ 3600;
                drawObjects(0);

                cancelAnimationFrame(requestId);
            }
            function drawLightTrace(xa,ya,p1,p4){
                // sun position
                var p2=[xw + (-sunx) * rscale, yw + (suny) * rscale,sunr1*rscale];
                // dx dy 4 lines
              
                const rs=1;
                var p3=[ [(p1[0]-p2[0])*rs,  (p1[1]- p1[2]-p2[1]+p2[2])*rs] ,
                     [(p1[0]-p2[0])*rs,      (p1[1]+ p1[2]-p2[1]+p2[2])*rs],
                     [(p1[0]-p2[0])*rs,      (p1[1]- p1[2]-p2[1]-p2[2])*rs],
                     [(p1[0]-p2[0])*rs,      (p1[1]+ p1[2]-p2[1]-p2[2])*rs] ];
                ;
                
                ctx.lineWidth = Math.min(1,1440000* rscale);
                ctx.beginPath();
                ctx.strokeStyle = 'yellow';
                // from sun
                ctx.moveTo(p1[0],p1[1]-p1[2]);
                ctx.lineTo(p1[0]+p3[0][0],p1[1]-p1[2]-p3[0][1]);
                ctx.moveTo(p1[0],p1[1]-p1[2]);
                ctx.lineTo(p1[0]+p3[2][0],p1[1]-p1[2]-p3[2][1]);

                ctx.moveTo(p1[0],p1[1]+p1[2]);
                ctx.lineTo(p1[0]+p3[1][0],p1[1]+p1[2]-p3[1][1]);
                ctx.moveTo(p1[0],p1[1]+p1[2]);
                ctx.lineTo(p1[0]+p3[3][0],p1[1]+p1[2]-p3[3][1]);
                // from obj
                ctx.stroke();
                ctx.beginPath();
                ctx.strokeStyle = '#555555';
                

                ctx.moveTo(p1[0],p1[1]-p1[2]);
                ctx.lineTo(p1[0]-p3[0][0]*0.01,p1[1]-p1[2]+p3[0][1]*0.01);
                ctx.moveTo(p1[0],p1[1]+p1[2]);
                ctx.lineTo(p1[0]-p3[3][0]*0.01,p1[1]+p1[2]+p3[3][1]*0.01);
                if (!(p4 === undefined)) {
                  var inshadow=!isCircleUnderLine(p4[0],p4[1],p4[2],
                                                p1[0],p1[1]-p1[2],p1[0]-p3[0][0]*0.01,p1[1]-p1[2]+p3[0][1]*0.01) 
                                                && 
                              isCircleUnderLine(p4[0],p4[1],p4[2],
                                                p1[0],p1[1]+p1[2],
                                                p1[0]-p3[3][0]*0.01,p1[1]+p1[2]+p3[3][1]*0.01 );    
                  mooninshadow=earthinshadow=false;
                  if (inshadow) {
                     const ma=Math.floor(moonangle*10);
                     earthinshadow=(ma>15) && (ma<46);
                     mooninshadow=!earthinshadow;
                  }
                }  
                
                ctx.stroke();
                ctx.beginPath();
                ctx.strokeStyle = '#888855';
                
                ctx.moveTo(p1[0],p1[1]+p1[2]);
                ctx.lineTo(p1[0]-p3[1][0]*0.01,p1[1]+p1[2]+p3[1][1]*0.01);
                ctx.moveTo(p1[0],p1[1]-p1[2]);
                ctx.lineTo(p1[0]-p3[2][0]*0.01,p1[1]-p1[2]+p3[2][1]*0.01);
                
                
                ctx.stroke();
                //return inshadow;
            }
            
            
            function drawObjects(i) {
                if (i == 0) {
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fill();

                    autoscale();
                    //if (followsatelite==4){
                      p=[xw + sunx * rscale, yw + suny * rscale, sunr1 * rscale];
                      ctx.beginPath();
                      ctx.arc(p[0],p[1], p[2],0, Math.PI * 2);
                      ctx.fillStyle = 'yellow';
                      ctx.fill();
                    //}
                    
                    
                    // Menggambar objek pertama (Bumi)
                    ctx.beginPath();
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 2;
                    p=[xw + x1 * rscale, yw + y1 * rscale, r1 * rscale];
                    p1=p;
                    ctx.arc(p[0],p[1], p[2],0, Math.PI * 2);
                    ctx.fillStyle = earthinshadow?'#223366':'blue';
                    ctx.fill();
                    ctx.beginPath();
                    
                    ctx.arc(p[0],p[1], p[2],Math.PI*1.5, Math.PI/2);
                    ctx.fillStyle = '#000022';
                    ctx.fill();
                    ctx.beginPath();

                    ctx.strokeStyle = 'white';  
                    ctx.moveTo(p[0],p[1]);
                    ctx.lineTo(p[0]+Math.sin(ro1)*p[2],p[1]+Math.cos(ro1)*p[2]);
                    ctx.stroke();

                    // Menggambar objek pertama (bulan)
                    ctx.beginPath();
                    ctx.strokeStyle = 'black'; 
                    p=[xw + moonx * rscale, yw + moony * rscale, moonr * rscale];
                    ctx.arc(p[0],p[1],p[2], 0,Math.PI * 2);
                    ctx.fillStyle = mooninshadow?'#282828':'gray';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(p[0],p[1],p[2], Math.PI*1.5, Math.PI/2);
                    ctx.fillStyle = '#222222';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.strokeStyle = 'white'; 
                    ctx.moveTo(p[0],p[1]);
                    ctx.lineTo(p[0]+Math.sin(ro2)*p[2],p[1]+Math.cos(ro2)*p[2]);
                    ctx.stroke();
                    
                    // garis dari matahari ke bulan
                    drawLightTrace(moonx,moony,p);
                    drawLightTrace(x1,y1,p1,p);
                    
                    
                }
                
                // Menggambar objek kedua (Objek bergerak)
                ctx.beginPath();
                ctx.arc(xw + x2 * rscale, yw + y2 * rscale, 20000 * rscale, 0, Math.PI * 2);
                ctx.fillStyle = satburn?'orange':'gray';
                ctx.fill();
                if (isRunning && ( satburn || stage<2)) {
                  ctx.beginPath();
                  ctx.arc(40, 40, 40-20*stage, 0, Math.PI * 2);
                  ctx.fillStyle = 'orange';
                  ctx.fill();
                }

                // Menggambar roket
                tv = Math.sqrt(vx3 * vx3 + vy3 * vy3);
                // buat menormalkan vy
                if (tv > 0) {
                    ctx.beginPath();
                    ctx.moveTo(xw + x3 * rscale, yw + y3 * rscale);
                    ctx.lineTo(xw + x3 * rscale - vx3 * rscale * 100011 / tv, yw + y3 * rscale - vy3 * rscale * 100011 / tv);
                    ctx.strokeStyle = 'gray';
                    ctx.lineWidth = 41210 * rscale;
                    ctx.stroke();
                    if (stage != 2 && Math.random() < 0.8) {
                        ctx.beginPath();
                        ctx.arc(xw + x3 * rscale - vx3 * rscale * 102011 / tv, yw + y3 * rscale - vy3 * rscale * 102011 / tv, 30000 * rscale, 0, Math.PI * 2);
                        ctx.fillStyle = 'orange';
                        ctx.fill();
                    }
                    
                }
                ctx.lineWidth = 1;
                if ($("trail1").checked){
                for (tr of trail) {

                    // Menggambar objek kedua (Objek bergerak)
                    ctx.beginPath();
                    ctx.arc(xw + tr[0] * rscale, yw + tr[1] * rscale, 10000 * rscale, 0, Math.PI * 2);
                    ctx.fillStyle = 'gray';
                    ctx.fill();

                    // Menggambar vektor pergerakan objek kedua
                    ctx.beginPath();
                    ctx.moveTo(xw + tr[0] * rscale, yw + tr[1] * rscale);
                    ctx.lineTo(xw + tr[0] * rscale + tr[2] * rscale * 45, yw + tr[1] * rscale + tr[3] * rscale * 45);
                    ctx.strokeStyle = '#00FF00FF';
                    ctx.stroke();

                    // Menggambar vektor roket
                    ctx.beginPath();
                    ctx.moveTo(xw + tr[0] * rscale, yw + tr[1] * rscale);
                    ctx.lineTo(xw + tr[0] * rscale + tr[4] * rscale * 0.05, yw + tr[1] * rscale - tr[5] * rscale * 0.05);
                    ctx.strokeStyle = 'orange';
                    ctx.stroke();

                    // Menggambar vektor force total
                    ctx.beginPath();
                    ctx.moveTo(xw + tr[0] * rscale, yw + tr[1] * rscale);
                    ctx.lineTo(xw + tr[0] * rscale + tr[6] * rscale * 0.5, yw + tr[1] * rscale + tr[7] * rscale * 0.5);
                    ctx.strokeStyle = 'red';
                    ctx.stroke();

                }
              }
            }

            // Fungsi menghitung gaya gravitasi
            let hc = 0;
            theV = 0;
            oldV = 0;
            theF = 0;
            theA = 0;
            tgV = 0;
            mooninshadow=0;
            earthinshadow=0;
            function isCircleUnderLine(circleCenterX, circleCenterY, circleRadius, lineStartX, lineStartY, lineEndX, lineEndY) {
              // Calculate the y-coordinate of the line at the circle's x-coordinate
              const slope = (lineEndY - lineStartY) / (lineEndX - lineStartX);
              const lineY = slope * (circleCenterX - lineStartX) + lineStartY;

              // Calculate the range of y-values that are considered "under" the line
              const minY = lineY + circleRadius;

              // Check if the circle's center is below the line
              return circleCenterY < minY;
            }
            var slowcheck=0;
            function shadowcheck(){

            }
            G = 6.67430e-11;
            function Gravity(A,B) {
                numcalc++;
                let dx = B[0] - A[0];
                let dy = B[1] - A[1];
                //   F = (G * m1 * m2) / d^2
                let distance = Math.sqrt(dx * dx + dy * dy);
                let force = (G * A[2] * B[2]) / (distance * distance);
                let Vectorangle = Math.atan2(dy, dx);
                return [force,distance,Vectorangle]
            }
            tidal=[];
            function calculateTidal(){
              // titik tengah earth
              tidal=[];
              tidal.push([0,0,Gravity([x1,y1,m1],[moonx,moony,moonmass]),Gravity([x1,y1,m1],[sunx,suny,sunm1])]);
              // data dari permukaan dibagi menjadi per 2 derajat 
              for (var i=0;i<180;i++){
                let a=4*Math.PI*i/360;
                x=Math.sin(a)*r1+x1;
                y=Math.cos(a)*r1+y1;
                var F=Gravity([x,y,m1],[moonx,moony,moonmass]);
                var F2=Gravity([x,y,m1],[sunx,suny,sunm1]);
                
                tidal.push([x,y,F,F2]); //[force,distance,angle]
              }
              
            }
            
            function drawTidalForce(){
              if (!$('tidalforce').checked)return;
              if (isRunning)calculateTidal();
              if (tidal.length==0)return;  
              // tidal force from moon
              ctx.beginPath();
              ctx.strokeStyle = "red" ;
              ctx.lineWidth = 1;//100000 * rscale;
              let t=tidal[0];
              let s=10000000.0/t[2][0];
              let fx0 = s*t[2][0] * Math.cos(t[2][2]);
              let fy0 = s*t[2][0] * Math.sin(t[2][2]);
              let fx0a = s*t[3][0] * Math.cos(t[3][2]);
              let fy0a = s*t[3][0] * Math.sin(t[3][2]);
              
              resultan=[];
              vie1= $('tidalmoon').checked;
              vie2= $('tidalsun').checked;
              vie3= $('tidalres').checked;
              for (var i=1;i<tidal.length;i++){
                let t=tidal[i];
                let x=t[0];
                let y=t[1];
                let fx = fx0-s*t[2][0] * Math.cos(t[2][2]);
                let fy = fy0-s*t[2][0] * Math.sin(t[2][2]);
                let p=[xw + x * rscale, yw + y * rscale];
                if (vie1){
                  ctx.moveTo(p[0],p[1]);
                  ctx.lineTo(p[0] - fx * rscale , p[1] - fy * rscale );
                }
                resultan.push([p,fx,fy]);
              }
              ctx.stroke();
              // tidal force from sun
              ctx.beginPath();
              ctx.strokeStyle = 'yellow';
              ctx.lineWidth = 1;//100000 * rscale;
              for (var i=1;i<tidal.length;i++){
                r=resultan[i-1];
                let t=tidal[i];
                let fx = fx0a-s*t[3][0] * Math.cos(t[3][2]);
                let fy = fy0a-s*t[3][0] * Math.sin(t[3][2]);
                r[1]+=fx;
                r[2]+=fy;
                if (vie2){
                  let p=r[0];
                  ctx.moveTo(p[0],p[1]);
                  ctx.lineTo(p[0] - fx * rscale , p[1] - fy * rscale );
                }
              }
              ctx.stroke();
              if (!vie3)return;
              // tidal force resultan
              ctx.beginPath();
              ctx.strokeStyle = '#ffffff88';
              ctx.lineWidth = 2;//100000 * rscale;
              for (var i=1;i<tidal.length;i++){
                r=resultan[i-1];
                let p=r[0];
                let fx=r[1];
                let fy=r[2];
                ctx.moveTo(p[0],p[1]);
                ctx.lineTo(p[0] - fx * rscale , p[1] - fy * rscale );
              }
              ctx.stroke();
            }
            var moonangle=0;
            function calculateMoon() {
                // calculate moon gravity to earth
                //   F = (G * m1 * m2) / d^2
                [force,distance,angle]=Gravity([x1,y1,m1],[moonx,moony,moonmass]);
                moonangle=angle;
                // pecah vektor ke X dan Y
                var fx = -force * Math.cos(angle);
                var fy = -force * Math.sin(angle);
                // V = V0 + a
                moonvx += (fx / moonmass);
                moonvy += (fy / moonmass);
                // S = S0 + V
                moonx += moonvx;
                moony += moonvy;
                
                // bumi juga aslinya bergerak
                // V = V0 + a
                vx1 -= (fx / m1);
                vy1 -= (fy / m1);
                // S = S0 + V
                x1 += vx1;
                y1 += vy1;
            }
            
            function calculateSun() {
                // calculate moon gravity to earth
                //   F = (G * m1 * m2) / d^2
                [force,distance,angle]=Gravity([x1,y1,m1],[sunx,suny,sunm1]);
                // pecah vektor ke X dan Y
                var fx = -force * Math.cos(angle);
                var fy = -force * Math.sin(angle);
                
                // bumi  bergerak
                // V = V0 + a
                vx1 -= (fx / m1);
                vy1 -= (fy / m1);
                // S = S0 + V
                x1 += vx1;
                y1 += vy1;
            }            
            function rocketBody() {
                [force,distance,angle]=Gravity([x1,y1,m1],[x3,y3,rm2]);
                if (distance < r1) {


                } else {

                    var fx = -force * Math.cos(angle);
                    var fy = -force * Math.sin(angle);
                    
          
                    vx3 += (fx / rm2);
                    vy3 += (fy / rm2);

                    x3 += vx3 * 1;
                    y3 += vy3 * 1;

                }
            }
            

            var angularsun=0.5;
            var lmangle=lmangle2=0;
            function calculateGravity() {
                ms=0;
                if (stage==0)ms = rm1+rm2+satm;
                if (stage==1)ms = rm2+satm;
                if (stage==2)ms = satm;
                [force,distance,angle]=Gravity([x1,y1,m1],[x2,y2,ms]);
                lmangle=angle;
                hc=distance-r1;
                if (distance < r1) {
                    vx2 = 0;
                    vy2 = 0;
                } else {
                    rfx=0;rfy=0;
                    fx =  - force * Math.cos(angle);
                    fy =  - force * Math.sin(angle);
                    if (stage == 1) {
                        rfy = rocketF2 * Math.cos(angle);fx+=rfx;
                        rfx = rocketF2 * Math.sin(angle);fy+=rfy;
                    }
                                        
                    // convert force to acceleration
                    vx2 += (fx / ms);
                    vy2 += (fy / ms);
                    // calculate to moon gravity
                    if (stage==2) {
                      fx=0;
                      fy=0;
                      if (satburn==1) { // add rocket force  to direction of rocket
                        fx += rocketF3 * vx2/theV;
                        fy += rocketF3 * vy2/theV;
                      }
                      if (satburn==2) { // add rocket force  to direction of rocket
                        fx -= rocketF3 * vx2/theV;
                        fy -= rocketF3 * vy2/theV;
                      }

                      [force2,distance2,angle2]=Gravity([moonx,moony,moonmass],[x2,y2,ms]);
                      lmangle2=angle2;
                      
                      if (satburn==3)force2+=rocketF3; // rocket with direction to moon 
                      
                      fx +=  - force2 * Math.cos(angle2);
                      fy +=  - force2 * Math.sin(angle2);
                      // convert force to acceleration
                      vx2 += (fx / ms);
                      vy2 += (fy / ms);

                    }
                    
                }
                
                oldV = theV;
                theV = Math.round(Math.sqrt(vx2 * vx2 + vy2 * vy2) * 3.600);
                theA = (theV - oldV) * 1000 / 3600;
                theF = theA * ms;
                if (theV > tgV) {
                    stage = 2;
                    brake = getval("brake");
                    vx3 *= brake;
                    vy3 *= brake;

                }
                x2 += vx2;
                y2 += vy2;

                // body rocket
                pushtrail([x2, y2, vx2, vy2, stage == 0 ? -rocketF1 : rfx, rfy, fx, fy]);
                if (stage < 2) {
                    x3 = x2;
                    y3 = y2;
                    vx3 = vx2;
                    vy3 = vy2;
                } else {
                    rocketBody();
                }
                calculateMoon();
                //calculateSun();
            }
            function getAngularSize(x,y,r) {
              
              // Calculate angular size in radians
              dis=Math.sqrt(x**2 + y**2);
              const angularSize = 2 * Math.atan(r / ( dis));

              return (angularSize*180/Math.PI).toFixed(2);

            }
            // Fungsi utama untuk mengupdate simulasi
            //
            function update(an) {
                if (isNaN(an) || an==0)an = parseInt(getval("anim"));
                $("pause1").style.display=isRunning?'none':'block';
                  for (i = 0; i < an; i++) {
                    if (isRunning){
                      simtime++;
                      if (runscript)
                          for (j=0;j<sactions.length;j++){
                            var ac=sactions[j];
                            if (ac[3]==0 && ac[0]==simtime) {
                              // execute thrust script
                                ac[3]=1;
                                if (ac[1]<=3){
                                  satburn=ac[1];burntime=ac[2]*60;
                                } else {isRunning=false; break;}
                            } 
                          }

                      if (stage == 0) {
                          vx2 += rocketF1 / (rm1+rm2+satm);
                          h0 += vx2;
                          x2 += vx2;
                          if (h0 >= h2)stage = 1;
                      } else if (stage == 1) {//vy2=v2;
                      } else if (stage == 2) {}
                      //i=0;
                      calculateGravity();
                      // body rotation
                      ro1+=vro1;
                      //ro2+=vro2;
                      // moon is tidal lock
                      ro2=-Math.PI/2-moonangle;
                      
                      burntime--;
                      if (burntime<0){
                        satburn=0;burntime=0;
                      }

                    }
                  }  
                drawObjects(0);
                drawTidalForce();
                if ($("fase3").checked){
                  // moon phase dikalkulasi dari sudut bulan dan sudu sinar matahari
                  phase=lmangle2-Math.PI/2;
                  // angular size
                  colb= [0,0,0];
                  angsize=getAngularSize(x2-moonx,y2-moony,moonr);
                  renderPhase('canvas2',50, 50, 25, colb,mooninshadow?[50,50,50]:[150,150,150],[-Math.cos(phase),0,Math.sin(phase)],"LM->Bulan "+angsize+"°");
                } else if ($("fase1").checked){
                  // moon phase dikalkulasi dari sudut bulan dan sudu sinar matahari
                  phase=moonangle+Math.PI/2;
                  // langit dipandang dari pengamat, bulan mati diamati siang hari misalnya
                  colb= calculateColorWithExposure(50, 100, 255, Math.max(0,-Math.sin(phase)));
                  // angular size
                  angsize=getAngularSize(x1-moonx,y1-moony,moonr);
                  renderPhase('canvas2',50, 50, 25*angsize/angularsun, earthinshadow?[0,0,0]:colb,[150,150,150],[-Math.cos(phase),0,Math.sin(phase)],"Bulan "+angsize+"°");
                
                }
                if ($("fase4").checked){
                  // fase bumi diamati dari bulan
                  phase=lmangle+Math.PI/2;
                  // langit gelap karena tanpa atmosfer
                  colb= [0,0,0];
                  angsize=getAngularSize(x2-x1,y2-y1,r1);
                  renderPhase('canvas3',100, 100, 80, colb,[100,150,255],[Math.cos(phase),0,-Math.sin(phase)],"LM->Bumi "+angsize+"°");
                }else if ($("fase2").checked){
                  // fase bumi diamati dari bulan
                  phase=moonangle+Math.PI/2;
                  // langit gelap karena tanpa atmosfer
                  colb= [0,0,0];
                  angsize=getAngularSize(x1-moonx,y1-moony,r1);
                  renderPhase('canvas3',100, 100, 20, colb,[100,150,255],[Math.cos(phase),0,-Math.sin(phase)],"Bumi "+angsize+"°");
                }
                // Menggambar info matahari
                ctx.beginPath();
                ctx.arc(1050,50, 25,0, Math.PI * 2);
                ctx.fillStyle = 'orange';
                ctx.fill();
                ctx.beginPath();
                ctx.fillStyle = 'White';
                angularsun=getAngularSize(sunx,suny,sunr1);
                ctx.fillText("Matahari "+angularsun+"°",1018,15);
                ctx.fill();
                let md=Math.sqrt((x1-moonx)**2+(y1-moony)**2);
                $("data").innerHTML = "SIMTIME:"+simtime+"<br># Gravity calculation:"+numcalc+"<br>V:" + theV + "km/h  H:" + Math.round(hc / 1000) + "km  F:" + Math.round(theF / 1000) + "kN  A:" + Math.round(theA) + "m/s^2<br>Jarak bulan:"+(md/1000).toFixed(0)+"km";
      
                requestId = requestAnimationFrame(update1);
            }
            function update1(){
              update(0);
            }

            // Event listener untuk tombol Start
            startBtn.addEventListener('click', ()=>{
                $("pause0").style.display="None";
                reset();
                drawObjects();
                isRunning = true;
                update(0);

            }
            );
                        // Event listener untuk tombol Start
            start2Btn.addEventListener('click', ()=>{
              $("pause0").style.display="None";
                reset();
                drawObjects();
                isRunning = true;
                runscript=true;
                update(10000000);
            }
            );

            // Event listener untuk tombol Pause
            pauseBtn.addEventListener('click', ()=>{
                if (isRunning) {
                    isRunning = false;

                } else {
                    isRunning = true;

                }
            }
            );

            // Event listener untuk tombol Reset
            view1.addEventListener('click', ()=>{
                followsatelite = 1;
            }
            );
            view2.addEventListener('click', ()=>{
                followsatelite = 2;
            }
            );
            view3.addEventListener('click', ()=>{
                followsatelite = 0;
                xw = canvas.width / 2+x1*rscale;
                // Posisi horizontal objek pertama (m)
                yw = canvas.height / 2+y1*rscale;
            }
            );
            view4.addEventListener('click', ()=>{
                followsatelite = 4;
            }
            );
            rem1.addEventListener('click', ()=>{
                moonvx *= 0.9;
                moonvy *= 0.9;
            }
            );
            rem2.addEventListener('click', ()=>{
                moonr = 1;
                moonmass = 1;
            }
            );
            applyG.addEventListener('click', ()=>{
                G = getval("cG");
            }
            );            
            // Function to handle the spacebar key press do rocket burn
            function handleSpacebarPress(event) {
                // Check if the pressed key is the Spacebar (keyCode 32)
                if (event.keyCode === 80) {
                    // Execute your desired action here
                    isRunning=!isRunning;
                }
                if (event.keyCode === 49) {
                    // Execute your desired action here
                    satburn = 1;
                    burntime=getval('burntime')*60;
                }
                if (event.keyCode === 50) {
                    // Execute your desired action here
                    satburn = 2;
                    burntime=getval('burntime')*60;
                }
                if (event.keyCode === 51) {
                    // Execute your desired action here
                    satburn = 3;
                    burntime=getval('burntime')*60;
                }                
            }

            // Get the textarea element by its id
            const actionTextArea = document.getElementById('actionList');

            // Function to parse and execute the list of actions

            function loadActions() {
                // Get the text content from the textarea
                const actionsText = actionTextArea.value;
                sactions=[];
                // Split the text into individual lines (each line represents an action)
                const actions = actionsText.split('\n');

                // Iterate through the actions
                actions.forEach((action, index) => {
                  
                    // Parse each action (assuming time and duration are separated by a comma)
                    
                    const [time,tipe, duration] = action.split(',').map(item => parseInt(item.trim()));
                    if (!isNaN(time)) sactions.push([time,tipe,duration,0]);
                });
            }


            // Add an event listener to the document to detect keydown events

            document.addEventListener('keyup', handleSpacebarPress);

            // Menggambar objek awal
            reset();
            drawObjects();
        </script>
    </body>
</html>
